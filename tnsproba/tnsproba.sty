% ---------------------- %
% -- IMPORTS REQUIRED -- %
% ---------------------- %

% A
\RequirePackage{amsmath}
% F
\RequirePackage{forest}
% S
\RequirePackage{simplekv}
% T
\RequirePackage{tnscom}
% X
\RequirePackage{xstring}

% TikZ libraries
\usetikzlibrary{babel}
\usetikzlibrary{calc}


% ------------- %
% -- GENERAL -- %
% ------------- %

% -- Semantic probability -- %

\newcommand\proba[2][p]{%
    \mathchoice{% * Display style
        #1\mskip-.65\medmuskip\left( #2 \right)%
    }{%           * Text style
        #1\mskip-.65\medmuskip\left( #2 \right)%
    }{%           * Script style
        #1\left( #2 \right)%
    }{%           * Script script style
        #1\left( #2 \right)%
    }
}



% -- Conditional probability -- %

\newcommand\tnsproba@abstract@proba@cond[4]{%
    #1{\proba[#2]{#3 \cap #4}}{\proba[#2]{#4}}%
}


\newcommand\probacond{\@ifstar{\tnsproba@proba@cond@star}{\tnsproba@proba@cond@no@star}}

\newcommand\tnsproba@proba@cond@no@star[3][p]{%
    \proba[#1_{#2}]{#3}%
}

\newcommand\tnsproba@proba@cond@star[3][p]{%
    \proba[#1]{#3 \mid #2}%
}


\newcommand\eprobacond{\@ifstar{\tnsproba@proba@cond@exp@star}{\tnsproba@proba@cond@exp@no@star}}

\newcommand\tnsproba@proba@cond@exp@star[3][p]{%
    \tnsproba@abstract@proba@cond{\frac}{#1}{#3}{#2}
}

\newcommand\tnsproba@proba@cond@exp@no@star[3][p]{%
    \tnsproba@abstract@proba@cond{\dfrac}{#1}{#3}{#2}
}



% -- "Not" event -- %

\newcommand\nevent[1]{%
    \overline{\kern.15ex#1\vphantom{#1^{x}}\kern.15ex}%
}



% -- Expected value - Variance - Standard deviation -- %

\newcommand\expval[2][\mathrm{E}]{%
    \proba[#1]{#2}%
}

\newcommand\var[2][\mathrm{V}]{%
    \proba[#1]{#2}%
}

\newcommand\stddev[2][\sigma]{%
    \proba[#1]{#2}%
}


% ----------- %
% -- BASIC -- %
% ----------- %

\useforestlibrary{linguistics}


% -- Global settings -- %

\forestset{
    declare count = {connections}{1}, 
	%
    apweight/.style = {
    	edge label = {
			node[pos=.5,sloped,above, fill=white]{#1}
		}
	},
    bpweight/.style = {
    	edge label = {
			node[pos=.5,sloped,below, fill=white]{#1}
		}
	},
    pweight/.style = {
    	edge label={
			node[midway, fill=white]{#1}
		}
	},
    pweight*/.style = {},
    apweight*/.style = {},
    bpweight*/.style = {},
}



% Sources
%    * https://stackoverflow.com/a/1873617/4589608
%    * ???? (all settings)
%    * https://tex.stackexchange.com/a/511763/6880 (hide/show the weights)
%    * https://tex.stackexchange.com/questions/554843/tikz-forest-align-pcomment*-contents-added-on-the-right-of-the-final-nodes/554855#554855

\newenvironment{probatree}{%
	\startprobatree%
}{}

\def\startprobatree#1\end{\tnsproba@tree{#1}\end}


\newcommand\tnsproba@tree[1]{
% Into the tree...
    \begin{forest}
        for tree = {%
            sn edges,
            grow'  = 0,
            l      = 2.5cm,
            s sep  = 1.2cm,
            anchor = parent,
        },
        before typesetting nodes = {%
            where connections = 1{}{%
                if = {isodd(connections())}{%
                    edge path' = {%
                        foreach \i [
                            count    = \j from 0,
                            evaluate = \noexpand\j
                            as \noexpand\k
                            using \noexpand {
                                (\j == 0) ?
                                0pt :
                                ((isodd(\j)) ?
                                (\j*4pt) :
                                ((-\j + 1)*4pt))
                            }
                        ]
                        in {%
                            1, ..., \foresteoption{connections}
                        }{
                            (!u.parent anchor)
                            --
                            ([yshift = \noexpand\k].child anchor)
                        }
                    },
                }{%
                    edge path' = {%
                        foreach \i [
                            count    = \j,
                            evaluate = \noexpand\j
                            as \noexpand\k
                            using {
                                (isodd(\j)) ?
                                (\j*4pt) :
                                ((-\j + 1)*4pt)
                            }
                        ]
                        in {1,...,\foresteoption{connections}}
                        {
                            (!u.parent anchor)
                            --
                            ([yshift = \noexpand\k].child anchor)
                        }
                    },
                },
            },
        },
        %
        pframe/.style = {
        	tikz = {
				\node [draw, ##1, line width = 1.5pt, rounded corners,fit to=tree]{};
			}
		},
		%
% USEFUL - TO KEEP 8
%
%		pcomment/.style={
%		    tikz+={
%		        \node [anchor=mid west, xshift=.4cm] at (.mid -| pcomment coord) {##1};
%	    	},
%		},
		tikz+={
    		\coordinate (ptreecomment coord) at (current bounding box.east);
		},
        #1
    \end{forest}
}


\newenvironment{probatree*}{
    \forestset{
    	pweight/.style={},
    	apweight/.style={},
    	bpweight/.style={},
	}
    \begin{probatree}
}{
    \end{probatree}
}


\newenvironment{probatree**}{
    \forestset{
        apweight*/.style = {
        	edge label = {
    			node[pos=.5,sloped,above, fill=white]{##1}
    		}
    	},
        bpweight*/.style = {
        	edge label = {
    			node[pos=.5,sloped,below, fill=white]{##1}
    		}
    	},
        pweight*/.style = {
        	edge label={
    			node[midway, fill=white]{##1}
    		}
    	},
    }
    \begin{probatree}
}{
    \end{probatree}
}


% ------------ %
% -- COMENT -- %
% ------------ %

% -- Comments -- %

\setKVdefault[tnsproba@comment@keys]{%
    col = black,
    dx  = 0cm,
    dy  = 0cm
}

% #1 : color
%
% #2 : node
% #3 : comment
\newcommand\ptreeComment{\@ifstar{\ptree@comment@star}{\ptree@comment@no@star}}

\newcommand\ptree@comment@no@star[3][]{
    \useKVdefault[tnsproba@comment@keys]%
    \setKV[tnsproba@comment@keys]{#1}%
    \edef\col{\useKV[tnsproba@comment@keys]{col}}%
    \edef\dx{\useKV[tnsproba@comment@keys]{dx}}%
    \edef\dy{\useKV[tnsproba@comment@keys]{dy}}%
	\node [anchor=mid west, xshift=.5cm+\dx, yshift=\dy] at (#2.mid -| ptreecomment coord) {%
		\textcolor{\col}{#3}%
	};
}



\newcommand\ptree@comment@star[3][]{
    \useKVdefault[tnsproba@comment@keys]%
    \setKV[tnsproba@comment@keys]{#1}%
    \edef\col{\useKV[tnsproba@comment@keys]{col}}%
    \edef\dx{\useKV[tnsproba@comment@keys]{dx}}%
    \edef\dy{\useKV[tnsproba@comment@keys]{dy}}%
	\node [anchor=mid west, xshift=.825cm, yshift=0cm] at (#2.mid) {%
		\textcolor{\col}{#3}%
	};
}


% ----------- %
% -- FRAME -- %
% ----------- %

% -- Frames -- %

\setKVdefault[tnsproba@frame@keys]{%
    col = blue
}


% #1 : color
% #2 : left start corner
% #3 : right up   corner
% #4 : right down corner
\newcommand\ptreeFrame[4][]{%
    \useKVdefault[tnsproba@frame@keys]%
    \setKV[tnsproba@frame@keys]{#1}%
    \edef\col{\useKV[tnsproba@frame@keys]{col}}%
    \node[draw = \col,
          line width = 1.5pt,
          rounded corners,
          fit = (#2)(#3)(#4)] {};
}


% ---------------- %
% -- FOCUS EDGE -- %
% ---------------- %

% -- Focus -- %

\newcommand\ptreeFocus{\@ifstar{\tnsproba@ptree@focus@star}{\tnsproba@ptree@focus@no@star}}

\newcommand\tnsproba@ptree@focus@star{\@ifstar{\tnsproba@ptree@focus@star@star}{\tnsproba@ptree@focus@star@no@star}}


\newcommand\tnsproba@ptree@focus@color{blue}


% #1 : number of the node
% #2 : the node
\newcommand\tnsproba@ptree@focus@abstract@node[2]{
	\node[draw       = \tnsproba@ptree@focus@color,
          line width = 1.5pt,
          inner sep  = 0pt,
          rounded corners,
          fit = (#2)(#2)(#2)] {};
}


% #1 : number of the node
% #2 : the node
\newcommand\tnsproba@ptree@focus@abstract@node@nostart[2]{
	\ifnum#1=1\else
    	\tnsproba@ptree@focus@abstract@node{#1}{#2}
    \fi
}


% #1 : node1 | node2 | ...
\newcommand\tnsproba@ptree@focus@abstract@multi@nodes[1]{
% Note
%
%    #1 : macro to apply
%    #2 : multi-args
	\tns@multi@apply@each{\tnsproba@ptree@focus@abstract@node}%
		                 {#1}
}


\newcommand\tnsproba@ptree@focus@abstract@multi@nodes@nostart[1]{
	\tns@multi@apply@each{\tnsproba@ptree@focus@abstract@node@nostart}%
		                 {#1}
}



% #1 : number of the couple of nodes
% #2 : start of the edge
% #3 : end   of the edge
\newcommand\tnsproba@ptree@focus@abstract@edge[3]{
    \draw[\tnsproba@ptree@focus@color,
          line cap   = round,
          line width = 1.5pt] 
    	 (#2.parent anchor) -- (#3.child anchor);
}


% #1 : node1 | node2 | ...
\newcommand\tnsproba@ptree@focus@abstract@multi@edges[1]{
% Note
%
%    #1 : macro to apply
%    #2 : multi-args
	\tns@multi@apply@couple{\tnsproba@ptree@focus@abstract@edge}%
	                       {#1}
}



\setKVdefault[tnsproba@focus@keys]{%
    col = blue
}

% #1 : color
% #2 : node1 | node2 | ...
\newcommand\tnsproba@ptree@focus@star@no@star[2][]{
    \useKVdefault[tnsproba@focus@keys]%
    \setKV[tnsproba@focus@keys]{#1}%
    \edef\col{\useKV[tnsproba@focus@keys]{col}}%
	\renewcommand\tnsproba@ptree@focus@color{\col}
	\tnsproba@ptree@focus@abstract@multi@edges{#2}
	\tnsproba@ptree@focus@abstract@multi@nodes@nostart{#2}
}

% #1 : color
% #2 : node1 | node2 | ...
\newcommand\tnsproba@ptree@focus@no@star[2][]{
    \useKVdefault[tnsproba@focus@keys]%
    \setKV[tnsproba@focus@keys]{#1}%
    \edef\col{\useKV[tnsproba@focus@keys]{col}}%
	\renewcommand\tnsproba@ptree@focus@color{\col}
	\tnsproba@ptree@focus@abstract@multi@edges{#2}
	\tnsproba@ptree@focus@abstract@multi@nodes{#2}
}

% #1 : color
% #2 : node1 | node2 | ...
\newcommand\tnsproba@ptree@focus@star@star[2][]{
    \useKVdefault[tnsproba@focus@keys]%
    \setKV[tnsproba@focus@keys]{#1}%
    \edef\col{\useKV[tnsproba@focus@keys]{col}}%
	\renewcommand\tnsproba@ptree@focus@color{\col}
	\tnsproba@ptree@focus@abstract@multi@edges{#2}
}


% -------------- %
% -- AUTO NUM -- %
% -------------- %

% -- Comments with auto numbering -- %

% #1 : color
%
% #2 : node
% #3 : comment
\newcommand\aptreeComment{\@ifstar{\aptree@comment@star}{\aptree@comment@no@star}}

\newcommand\aptree@comment@no@star[3][]{
	\ptree@comment@no@star[#1]{!#2}{#3}
}



\newcommand\aptree@comment@star[3][]{
	\ptree@comment@star[#1]{!#2}{#3}
}



% -- Frames with auto numbering -- %

% #1 : color
% #2 : left start corner
% #3 : right up   corner
% #4 : right down corner
\newcommand\aptreeFrame[4][]{%
    \ptreeFrame[#1]{!#2}{!#3}{!#4}%
}



% -- Focus with auto numbering -- %

\newcommand\aptreeFocus{\@ifstar{\tnsproba@ptree@focus@auto@star}{\tnsproba@ptree@focus@auto@no@star}}

\newcommand\tnsproba@ptree@focus@auto@star{\@ifstar{\tnsproba@ptree@focus@auto@star@star}{\tnsproba@ptree@focus@auto@star@no@star}}

% #1 : one node
\newcommand\tnsproba@ptree@focus@auto@abstract@node[2]{
	\node[draw       = \tnsproba@ptree@focus@color,
          line width = 1.5pt,
          inner sep  = 0pt,
          rounded corners,
          fit = (!#2)(!#2)(!#2)] {};
}


% #1 : number of the node
% #2 : the node
\newcommand\tnsproba@ptree@focus@auto@abstract@node@nostart[2]{
	\ifnum#1=1\else
    	\tnsproba@ptree@focus@auto@abstract@node{#1}{#2}
    \fi
}


% #1 : node1 | node2 | ...
\newcommand\tnsproba@ptree@focus@auto@abstract@multi@nodes[1]{
% Note
%
%    #1 : macro to apply
%    #2 : multi-args
	\tns@multi@apply@each{\tnsproba@ptree@focus@auto@abstract@node}%
		                 {#1}
}


\newcommand\tnsproba@ptree@focus@auto@abstract@multi@nodes@nostart[1]{
	\tns@multi@apply@each{\tnsproba@ptree@focus@auto@abstract@node@nostart}%
		                 {#1}
}



% #1 : number of the couple of nodes
% #2 : start of the edge
% #3 : end   of the edge
\newcommand\tnsproba@ptree@focus@auto@abstract@edge[3]{
    \draw[\tnsproba@ptree@focus@color,
          line cap   = round,
          line width = 1.5pt] 
    	 (!#2.parent anchor) -- (!#3.child anchor);
}


% #1 : node1 | node2 | ...
\newcommand\tnsproba@ptree@focus@auto@abstract@multi@edges[1]{
% Note
%
%    #1 : macro to apply
%    #2 : multi-args
	\tns@multi@apply@couple{\tnsproba@ptree@focus@auto@abstract@edge}%
	                       {#1}
}



\setKVdefault[tnsproba@focus@auto@keys]{%
    col = blue
}

% #1 : color
% #2 : node1 | node2 | ...
\newcommand\tnsproba@ptree@focus@auto@star@no@star[2][]{
    \useKVdefault[tnsproba@focus@auto@keys]%
    \setKV[tnsproba@focus@auto@keys]{#1}%
    \edef\col{\useKV[tnsproba@focus@auto@keys]{col}}%
	\renewcommand\tnsproba@ptree@focus@color{\col}
	\tnsproba@ptree@focus@auto@abstract@multi@edges{#2}
	\tnsproba@ptree@focus@auto@abstract@multi@nodes@nostart{#2}
}

% #1 : color
% #2 : node1 | node2 | ...
\newcommand\tnsproba@ptree@focus@auto@no@star[2][]{
    \useKVdefault[tnsproba@focus@auto@keys]%
    \setKV[tnsproba@focus@auto@keys]{#1}%
    \edef\col{\useKV[tnsproba@focus@auto@keys]{col}}%
	\renewcommand\tnsproba@ptree@focus@color{\col}
	\tnsproba@ptree@focus@auto@abstract@multi@edges{#2}
	\tnsproba@ptree@focus@auto@abstract@multi@nodes{#2}
}

% #1 : color
% #2 : node1 | node2 | ...
\newcommand\tnsproba@ptree@focus@auto@star@star[2][]{
    \useKVdefault[tnsproba@focus@auto@keys]%
    \setKV[tnsproba@focus@auto@keys]{#1}%
    \edef\col{\useKV[tnsproba@focus@auto@keys]{col}}%
	\renewcommand\tnsproba@ptree@focus@color{\col}
	\tnsproba@ptree@focus@auto@abstract@multi@edges{#2}
}

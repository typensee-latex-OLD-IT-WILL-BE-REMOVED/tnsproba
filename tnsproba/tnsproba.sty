% ---------------------- %
% -- IMPORTS REQUIRED -- %
% ---------------------- %

% A
\RequirePackage{amsmath}
% F
\RequirePackage{forest}

% TikZ libraries
\usetikzlibrary{calc}


% ---------- %
% -- BASE -- %
% ---------- %

% Semantic probability

\newcommand\proba[2][p]{%
    \mathchoice{% * Display style
        #1\mskip-.65\medmuskip\left( #2 \right)%
    }{%           * Text style
        #1\mskip-.65\medmuskip\left( #2 \right)%
    }{%           * Script style
        #1\left( #2 \right)%
    }{%           * Script script style
        #1\left( #2 \right)%
    }
}


% Conditional probability

\newcommand\@abstract@proba@cond[4]{%
    #1{\proba[#2]{#3 \cap #4}}{\proba[#2]{#4}}%
}


\newcommand\probacond{\@ifstar{\@probacond@star}{\@probacond@no@star}}

\newcommand\@probacond@no@star[3][p]{%
    \proba[#1_{#2}]{#3}%
}

\newcommand\@probacond@star[3][p]{%
    \proba[#1]{#3 \mid #2}%
}


\newcommand\probacondexp{\@ifstar{\@probacondexp@star}{\@probacondexp@no@star}}

\newcommand\@probacondexp@star[3][p]{%
    \@abstract@proba@cond{\frac}{#1}{#3}{#2}
}

\newcommand\@probacondexp@no@star[3][p]{%
    \@abstract@proba@cond{\dfrac}{#1}{#3}{#2}
}


% Expected value 

\newcommand\expval[2][E]{%
    \proba[\mathrm{#1}]{#2}%
}


% ---------- %
% -- TREE -- %
% ---------- %

\useforestlibrary{linguistics}
\forestset{
    declare count   = {connections}{1},
    frame/.style    = {tikz={\node [draw, #1, thick, rounded corners,fit to=tree]{};}},
    apweight/.style = {edge label={node[pos=.5,sloped,above, fill=white]{#1}}},
    bpweight/.style = {edge label={node[pos=.5,sloped,below, fill=white]{#1}}},
    pweight/.style  = {edge label={node[midway, fill=white]{#1}}},
    pweight*/.style = {}
}
% Sources
%    * ???? (all settings)
%    * https://tex.stackexchange.com/a/511763/6880 (hide/show the weights)

\newcommand\@proba@tree[1]{
    \begin{forest}
        for tree = {%
            sn edges,
            grow'  = 0,
            l      = 2.5cm,
            s sep  = 1.2cm,
            anchor = parent,
        },
        before typesetting nodes = {%
            where connections = 1{}{%
                if = {isodd(connections())}{%
                    edge path' = {%
                        foreach \i [
                            count    = \j from 0,
                            evaluate = \noexpand\j
                            as \noexpand\k
                            using \noexpand {
                                (\j == 0) ?
                                0pt :
                                ((isodd(\j)) ?
                                (\j*4pt) :
                                ((-\j + 1)*4pt))
                            }
                        ]
                        in {%
                            1, ..., \foresteoption{connections}
                        }{
                            (!u.parent anchor)
                            --
                            ([yshift = \noexpand\k].child anchor)
                        }
                    },
                }{%
                    edge path' = {%
                        foreach \i [
                            count    = \j,
                            evaluate = \noexpand\j
                            as \noexpand\k
                            using {
                                (isodd(\j)) ?
                                (\j*4pt) :
                                ((-\j + 1)*4pt)
                            }
                        ]
                        in {1,...,\foresteoption{connections}}
                        {
                            (!u.parent anchor)
                            --
                            ([yshift = \noexpand\k].child anchor)
                        }
                    },
                },
            },
        },
        #1
    \end{forest}
}

% Source: https://stackoverflow.com/a/1873617/4589608
\newenvironment{probatree}{\startprobatree}{}
\def\startprobatree#1\end{\@proba@tree{#1}\end}

\newenvironment{probatree*}{
    \forestset{pweight/.style={}}
    \begin{probatree}
}{
    \end{probatree}
}
